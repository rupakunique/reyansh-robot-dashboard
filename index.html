<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ü§ñ RoboReyansh ‚Äì Global Control</title>

<!-- MQTT over WebSocket -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:linear-gradient(135deg,#0a0e1a,#1a2338);
  color:#e0e6ff;
  font-family:Segoe UI,Arial;
  text-align:center;
  padding:15px;
  min-height:100vh
}
h1{
  margin:20px 0;
  font-size:26px;
  background:linear-gradient(45deg,#00d4ff,#7df9ff);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.status{
  padding:10px;
  margin:10px auto;
  max-width:360px;
  border-radius:12px;
  font-weight:700
}
.ok{background:#00ff88;color:#000}
.bad{background:#ff4444;color:#fff}

.panel{
  background:#0b1220;
  border-radius:14px;
  padding:14px;
  margin:14px auto;
  max-width:380px;
  box-shadow:0 0 15px rgba(0,255,255,.15)
}
.bar{
  position:relative;
  height:14px;
  background:#1b2338;
  border-radius:10px;
  margin:10px 0;
  overflow:hidden
}
.bar span{
  display:block;
  height:100%;
  width:0%;
  border-radius:10px
}
#L{background:#00c6ff}
#F{background:#00ff88}
#R{background:#ff9f00}
#mL{background:#b388ff}
#mR{background:#ff80ab}

#joyWrap{
  width:200px;
  height:200px;
  margin:20px auto;
  border-radius:50%;
  background:#0f1628;
  position:relative;
  box-shadow:0 0 30px rgba(0,212,255,.3)
}
#joy{
  width:80px;
  height:80px;
  border-radius:50%;
  background:#7df9ff;
  position:absolute;
  left:60px;
  top:60px;
  box-shadow:0 6px 20px rgba(0,212,255,.6)
}
button{
  padding:14px 26px;
  margin:10px;
  border:none;
  border-radius:12px;
  font-weight:700;
  font-size:15px;
  cursor:pointer
}
.stop{background:#ff4444;color:#fff}
</style>
</head>

<body>

<h1>ü§ñ RoboReyansh ‚Äì Global Control</h1>
<div id="status" class="status bad">üîå Connecting to Cloud‚Ä¶</div>

<div class="panel">
  <b>üì° Radar Distance (cm)</b>
  <div class="bar"><span id="L"></span></div>
  <div class="bar"><span id="F"></span></div>
  <div class="bar"><span id="R"></span></div>
</div>

<div class="panel">
  <b>‚öô Motor Power</b>
  <div class="bar"><span id="mL"></span></div>
  <div class="bar"><span id="mR"></span></div>
</div>

<div id="joyWrap">
  <div id="joy"></div>
</div>

<button class="stop" onclick="send(0,0)">‚èπ EMERGENCY STOP</button>

<script>
/* ================= MUST MATCH ESP32 ================= */
const ROBOT_ID = "RRX9A72";          // SAME AS ESP32
const TOKEN    = "R3Y@NSH_2026";     // SAME AS ESP32

const TOPIC_CMD   = `reyansh/${ROBOT_ID}/cmd`;
const TOPIC_STATE = `reyansh/${ROBOT_ID}/state`;

/* ================= UI ELEMENTS ================= */
const statusDiv = document.getElementById("status");
const L  = document.getElementById("L");
const F  = document.getElementById("F");
const R  = document.getElementById("R");
const mL = document.getElementById("mL");
const mR = document.getElementById("mR");

/* ================= MQTT CONNECT ================= */
const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

client.on("connect", () => {
  statusDiv.className = "status ok";
  statusDiv.innerHTML = "üåç Connected ‚Äì Global Control Active";
  client.subscribe(TOPIC_STATE);
});

client.on("close", () => {
  statusDiv.className = "status bad";
  statusDiv.innerHTML = "‚ùå Disconnected";
});

/* ================= RECEIVE TELEMETRY ================= */
client.on("message", (topic, msg) => {
  if (topic !== TOPIC_STATE) return;
  const d = JSON.parse(msg.toString());

  L.style.width  = d.L  / 250 * 100 + "%";
  F.style.width  = d.F  / 250 * 100 + "%";
  R.style.width  = d.R  / 250 * 100 + "%";
  mL.style.width = Math.abs(d.mL) / 255 * 100 + "%";
  mR.style.width = Math.abs(d.mR) / 255 * 100 + "%";
});

/* ================= SEND COMMAND ================= */
function send(l, r){
  client.publish(
    TOPIC_CMD,
    JSON.stringify({
      token: TOKEN,    // üîê REQUIRED
      L: Math.round(l),
      R: Math.round(r)
    })
  );
}

/* ================= JOYSTICK ================= */
const joy = document.getElementById("joy");
const wrap = document.getElementById("joyWrap");
const C = 100;
let active = false;

wrap.onpointerdown = e => { active = true; move(e); };
wrap.onpointermove = e => active && move(e);
wrap.onpointerup = wrap.onpointerleave = () => {
  active = false;
  joy.style.left = "60px";
  joy.style.top  = "60px";
  send(0,0);
};

function move(e){
  const r = wrap.getBoundingClientRect();
  let dx = e.clientX - r.left - C;
  let dy = e.clientY - r.top  - C;
  const d = Math.hypot(dx,dy);
  if(d > 70){ dx *= 70/d; dy *= 70/d; }
  joy.style.left = C + dx - 40 + "px";
  joy.style.top  = C + dy - 40 + "px";
  send((-dy + dx) * 1.8, (-dy - dx) * 1.8);
}
</script>

</body>
</html>
